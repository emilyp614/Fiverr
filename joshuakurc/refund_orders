create view "RIOT_SHOPIFY"."SHOPIFY_RIOTSTORES"."ORDER_REFUNDS_FLATTENED" AS (

select
        ADMIN_GRAPHQL_API_ID,
        CREATED_AT,
        ID,
        NOTE,
        order_adjustments.value:amount::string as order_adj_amount,
        order_adjustments.value:id::string as order_adj_id,
        order_adjustments.value:kind::string as order_adj_kind,
        order_adjustments.value:reason::string as order_adj_reason,
        order_adjustments.value:refund_id::string as order_adj_refund_id,
        order_adjustments.value:tax_amount::string as order_adj_tax_amount,
        ORDER_ID,
        PROCESSED_AT,
        refund_li.value:id::string as refund_li_id,
        refund_li.value:line_item:admin_graphql_api_id::string as refund_li_admin_graphql_api_id,
        ref_li_dis_alloc.value:amount::string as ref_li_dis_alloc_amount,
        ref_li_dis_alloc.value:amount_set:presentment_money:amount::string as ref_li_dis_alloc_pres_money_amount,
        ref_li_dis_alloc.value:amount_set:presentment_money:currency_code::string as ref_li_dis_alloc_pres_money_curr_code,
        ref_li_dis_alloc.value:amount_set:shop_money:amount::string as ref_li_dis_alloc_shop_money_amount,
        ref_li_dis_alloc.value:amount_set:shop_money:currency_code::string as ref_li_dis_alloc_shop_money_curr_code,
        ref_li_dis_alloc.value:discount_application_index::string as ref_li_dis_alloc_disc_app_index,
        refund_li.value:line_item:fulfillable_quantity::string as refund_li_fulfillable_quantity,
        refund_li.value:line_item:fulfillment_service::string as refund_li_fulfillment_service,
        refund_li.value:line_item:fulfillment_status::string as refund_li_fulfillment_status,
        refund_li.value:line_item:gift_card::string as refund_li_gift_card,
        refund_li.value:line_item:grams::string as refund_li_grams,
        refund_li.value:line_item:id::string as refund_li_line_item_id,
        refund_li.value:line_item:name::string as refund_li_line_item_name,
        refund_li.value:line_item:price::string as refund_li_line_item_price, 
        refund_li.value:line_item:price_set:presentment_money:amount::string as ref_li_price_pres_money_amount,
        refund_li.value:line_item:price_set:presentment_money:currency_code::string as ref_li_price_pres_money_curr_code,
        refund_li.value:line_item:price_set:shop_money:amount::string as ref_li_price_shop_money_amount,
        refund_li.value:line_item:price_set:shop_money:currency_code::string as ref_li_price_shop_money_curr_code,
        refund_li.value:line_item:product_exists::string as ref_li_product_exists,
        refund_li.value:line_item:product_id::string as ref_li_product_id,
        ref_li_properties.value:name::string as ref_li_properties_name,
        ref_li_properties.value:value::string as ref_li_properties_value,
        refund_li.value:line_item:quantity::string as ref_li_line_item_quantity,
        refund_li.value:line_item:requires_shipping::string as ref_li_line_item_requires_shipping,
        refund_li.value:line_item:sku::string as ref_li_line_item_sku,
        ref_li_tax_lines.value:price::string as ref_li_tax_price,
        ref_li_tax_lines.value:price_set:presentment_money:amount::string as ref_li_tax_price_pres_money_amount,
        ref_li_tax_lines.value:price_set:presentment_money:currency_code::string as ref_li_tax_price_pres_money_curr_code,
        ref_li_tax_lines.value:price_set:shop_money:amount::string as ref_li_tax_price_shop_money_amount,
        ref_li_tax_lines.value:price_set:shop_money:currency_code::string as ref_li_tax_price_shop_money_curr_code,
        ref_li_tax_lines.value:rate::string as ref_li_tax_rate,
        ref_li_tax_lines.value:title::string as ref_li_tax_title,
        refund_li.value:line_item:taxable::string as refund_li_taxable,
        refund_li.value:line_item:title::string as refund_li_title,
        refund_li.value:line_item:total_discount::string as refund_li_total_discount,
        refund_li.value:line_item:total_discount_set:presentment_money:amount::string as ref_li_discount_pres_money_amount,
        refund_li.value:line_item:total_discount_set:presentment_money:currency_code::string as ref_li_discount_pres_money_curr_code,
        refund_li.value:line_item:total_discount_set:shop_money:amount::string as ref_li_discount_shop_money_amount,
        refund_li.value:line_item:total_discount_set:shop_money:currency_code::string as ref_li_discount_shop_money_curr_code,
        refund_li.value:line_item:variant_id::string as refund_li_variant_id,
        refund_li.value:line_item:variant_inventory_management::string as refund_li_variant_inventory_management,
        refund_li.value:line_item:variant_title::string as refund_li_variant_title,
        refund_li.value:line_item:vendor::string as refund_li_vendor,
        refund_li.value:line_item_id::string as ref_li_line_item_id,
        refund_li.value:location_id::string as ref_li_location_id,
        refund_li.value:quantity::string as ref_li_quantity,
        refund_li.value:restock_type::string as ref_li_restock_type,
        refund_li.value:subtotal::string as ref_li_subtotal,
        refund_li.value:subtotal_set:presentment_money:amount::string as ref_li_subtotal_pres_money_amount,
        refund_li.value:subtotal_set:presentment_money:currency_code::string as ref_li_subtotal_pres_money_curr_code,
        refund_li.value:subtotal_set:shop_money:amount::string as ref_li_subtotal_shop_money_amount,
        refund_li.value:subtotal_set:shop_money:currency_code::string as ref_li_subtotal_shop_money_curr_code,
        refund_li.value:total_tax::string as ref_li_total_tax,
        refund_li.value:total_tax_set:presentment_money:amount::string as ref_li_total_tax_pres_money_amount,
        refund_li.value:total_tax_set:presentment_money:currency_code::string as ref_li_total_tax_pres_money_curr_code,
        refund_li.value:total_tax_set:shop_money:amount::string as ref_li_total_tax_shop_money_amount,
        refund_li.value:total_tax_set:shop_money:currency_code::string as ref_li_total_tax_shop_curr_code,
        RESTOCK,
        USER_ID,
        _SDC_BATCHED_AT,
        _SDC_EXTRACTED_AT,
        _SDC_RECEIVED_AT,
        _SDC_SEQUENCE,
        _SDC_TABLE_VERSION
        
FROM "RIOT_SHOPIFY"."SHOPIFY_RIOTSTORES"."ORDER_REFUNDS"
,LATERAL FLATTEN(INPUT=>ORDER_ADJUSTMENTS) order_adjustments
,LATERAL FLATTEN(INPUT=>REFUND_LINE_ITEMS) refund_li
,LATERAL FLATTEN(INPUT=>refund_li.value:line_item:discount_allocations) ref_li_dis_alloc
,LATERAL FLATTEN(INPUT=>refund_li.value:line_item:tax_lines) ref_li_tax_lines
,LATERAL FLATTEN(INPUT=>refund_li.value:line_item:properties) ref_li_properties  
  
  );
        
