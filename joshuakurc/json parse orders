//create view ORDERS_FLATTENED AS (
select 
billing_address:address1::string as billing_address1,
billing_address:address2::string as billing_address2,
billing_address:city::string as billing_city,
billing_address:company::string as billing_company,
billing_address:country::string as billing_country,
billing_address:country_code::string as billing_country_code,
billing_address:first_name::string as billing_first_name,
billing_address:last_name::string as billing_last_name,
billing_address:latitude::string as billing_latitude,
billing_address:longitude::string as billing_longitude,
billing_address:name::string as billing_name,
billing_address:phone::string as billing_phone,
billing_address:province::string as billing_province,
billing_address:province_code::string as billing_province_code,
billing_address:zip::string as billing_zip,
client_details:accept_language::string as accept_language,
client_details:browser_height::string as browser_height,
client_details:browser_ip::string as browser_ip,
client_details:browser_width::string as browser_width,
client_details:session_hash::string as session_hash,
client_details:user_agent::string as user_agent,
customer:accepts_marketing::string as cust_accepts_marketing,
customer:accepts_marketing_updated_at::string as cust_accepts_marketing_updated_at,
customer:admin_graphql_api_id::string as cust_admin_graphql_api_id,
customer:created_at::string as cust_created_at,
customer:currency::string as cust_currency,
discount_applications:allocation_method::string as disc_app_allocation_method,
discount_applications:description::string as disc_app_description,
discount_applications:target_selection::string as disc_app_target_selection,
discount_applications:target_type::string as disc_app_target_type,
discount_applications:title::string as disc_app_title,
discount_applications:type::string as disc_app_type,
discount_applications:value::string as disc_app_value,
discount_applications:value_type::string as disc_app_value_type,
fa.value:admin_graphql_api_id::string as ful_admin_graphql_api_id,
fa.value:created_at::string as ful_created_at,
fa.value:id::string as ful_id,
fa.value:location_id::string as ful_location_id,
fa.value:name::string as ful_name,
fa.value:receipt::string as ful_receipt,
fa.value:service::string as ful_service,
fa.value:shipment_status::string as ful_shipment_status,
fa.value:status::string as ful_status,
fa.value:tracking_company::string as ful_tracking_company,
fa.value:tracking_number::string as ful_tracking_number,
fa_line_items.value:admin_graphql_api_id::string as fa_li_admin_graphql_api_id,
fa_line_items.value:desination_location:address1::string as fa_li_dest_loc_address1,
fa_line_items.value:desination_location:address2::string as fa_li_dest_loc_address2,
fa_line_items.value:desination_location:city::string as fa_li_dest_loc_city,
fa_line_items.value:desination_location:country_code::string as fa_li_dest_loc_country_code,
fa_line_items.value:desination_location:id::string as fa_li_dest_loc_id,
fa_line_items.value:desination_location:name::string as fa_li_dest_loc_name,
fa_line_items.value:desination_location:province_code::string as fa_li_dest_loc_province_code,
fa_line_items.value:desination_location:zip::string as fa_li_dest_loc_zip,
fa_line_items.value:discount_allocations::string as fa_li_discount_allocations,
fa_line_items.value:fulfillable_quantity::string as fa_li_fulfillable_quantity,
fa_line_items.value:fulfillment_service::string as fa_li_fulfillment_service,
fa_line_items.value:fulfillment_status::string as fa_li_fulfillment_status,
fa_line_items.value:gift_card::string as fa_li_gift_card,
fa_line_items.value:grams::string as fa_li_grams,
fa_line_items.value:id::string as fa_li_id,
fa_line_items.value:name::string as fa_li_name,
fa_line_items.value:price::string as fa_li_price,
fa_line_items.value:product_exists::string as fa_li_product_exists,
fa_line_items.value:product_id::string as fa_li_product_id,
fa_line_items.value:properties::string as fa_li_properties,//needs further array breakdown
fa_line_items.value:quantity::string as fa_li_quantity,
fa_line_items.value:requires_shipping::string as fa_li_requires_shipping,
fa_line_items.value:sku::string as fa_li_sku,
fa_line_items.value:taxable::string as fa_li_taxable,
fa_line_items.value:title::string as fa_li_title,
fa_line_items.value:total_discount::string as fa_li_total_discount,
fa_line_items.value:variant_id::string as fa_li_variant_id,
fa_line_items.value:variant_inventory_management::string as fa_li_variant_inventory_management,
fa_line_items.value:variant_title::string as fa_li_variant_title,
fa_line_items.value:vendor::string as fa_li_vendor,
fa_line_items.value:origin_location:address1::string as fa_li_orig_loc_address1,
fa_line_items.value:origin_location:address2::string as fa_li_orig_loc_address2,
fa_line_items.value:origin_location:city::string as fa_li_orig_loc_city,
fa_line_items.value:origin_location:country_code::string as fa_li_orig_loc_country_code,
fa_line_items.value:origin_location:id::string as fa_li_orig_loc_id,
fa_line_items.value:origin_location:name::string as fa_li_orig_loc_name,
fa_line_items.value:origin_location:province_code::string as fa_li_orig_loc_province_code,
fa_line_items.value:origin_location:zip::string as fa_li_orig_loc_zip,
fa_line_items.value:price_set:presentment_money:amount::string as fa_li_price_set_pres_money_amount,
fa_line_items.value:price_set:presentment_money:currency_code::string as fa_li_price_set_pres_money_curr_code,
fa_line_items.value:price_set:shop_money:amount::string as fa_li_price_set_shop_money_amount,
fa_line_items.value:price_set:shop_money:currency_code::string as fa_li_price_set_shop_money_curr_code,
fa_line_items_tax_lines.value:price::string as fa_li_tax_price,
fa_line_items_tax_lines.value:price_set:presentment_money:amount::string as fa_li_tax_pres_money,
fa_line_items_tax_lines.value:price_set:presentment_money:currency_code::string as fa_li_tax_pres_curr_code,
fa_line_items_tax_lines.value:price_set:shop_money:amount::string as fa_li_tax_shop_money,
fa_line_items_tax_lines.value:price_set:shop_money:currency_code::string as fa_li_tax_shop_curr_code,
fa_line_items_tax_lines.value:rate::string as fa_li_tax_rate,
fa_line_items_tax_lines.value:title::string as fa_li_tax_title,
fa_line_items.value:total_discount_set:presentment_money:amount::string as fa_li_discount_set_pres_money_amount,
fa_line_items.value:total_discount_set:presentment_money:currency_code::string as fa_li_discount_set_pres_money_curr_code,
fa_line_items.value:total_discount_set:shop_money:amount::string as fa_li_discount_set_shop_money_amount,
fa_line_items.value:total_discount_set:shop_money:currency_code::string as fa_li_discount_set_shop_money_curr_code,
li.value:admin_graphql_api_id::string as li_admin_graphql_api_id,
li.value:discount_allocations::string as li_discount_allocations,
li.value:fulfillable_quantity::string as li_fulfillable_quantity,
li.value:fulfillment_service::string as li_fulfillment_service,
li.value:fulfillment_status::string as li_fulfillment_status,
li.value:gift_card::string as li_gift_card,
li.value:grams::string as li_grams,
li.value:id::string as li_id,
li.value:name::string as li_name,
li.value:price::string as li_price,
li.value:product_exists::string as li_product_exists,
li.value:product_id::string as li_product_id,
li.value:properties::string as li_properties,//needs further array breakdown
li.value:quantity::string as li_quantity,
li.value:requires_shipping::string as li_requires_shipping,
li.value:sku::string as li_sku,
li.value:taxable::string as li_taxable,
li.value:title::string as li_title,
li.value:total_discount::string as li_total_discount,
li.value:variant_id::string as li_variant_id,
li.value:variant_inventory_management::string as li_variant_inventory_management,
li.value:variant_title::string as li_variant_title,
li.value:vendor::string as li_vendor,
//need to break down arrays just like full_line_items
li.value:origin_location:address1::string as li_orig_loc_address1,
li.value:origin_location:address2::string as li_orig_loc_address2,
li.value:origin_location:city::string as li_orig_loc_city,
li.value:origin_location:country_code::string as li_orig_loc_country_code,
li.value:origin_location:id::string as li_orig_loc_id,
li.value:origin_location:name::string as li_orig_loc_name,
li.value:origin_location:province_code::string as li_orig_loc_province_code,
li.value:origin_location:zip::string as li_orig_loc_zip,
li.value:price_set:presentment_money:amount::string as li_price_set_pres_money_amount,
li.value:price_set:presentment_money:currency_code::string as li_price_set_pres_money_curr_code,
li.value:price_set:shop_money:amount::string as li_price_set_shop_money_amount,
li.value:price_set:shop_money:currency_code::string as li_price_set_shop_money_curr_code,
line_items_tax_lines.value:price::string as li_tax_price,
line_items_tax_lines.value:price_set:presentment_money:amount::string as li_tax_pres_money,
line_items_tax_lines.value:price_set:presentment_money:currency_code::string as li_tax_pres_curr_code,
line_items_tax_lines.value:price_set:shop_money:amount::string as li_tax_shop_money,
line_items_tax_lines.value:price_set:shop_money:currency_code::string as li_tax_shop_curr_code,
line_items_tax_lines.value:rate::string as li_tax_rate,
line_items_tax_lines.value:title::string as li_tax_title,
li.value:total_discount_set:presentment_money:amount::string as li_discount_set_pres_money_amount,
li.value:total_discount_set:presentment_money:currency_code::string as li_discount_set_pres_money_curr_code,
li.value:total_discount_set:shop_money:amount::string as li_discount_set_shop_money_amount,
li.value:total_discount_set:shop_money:currency_code::string as li_discount_set_shop_money_curr_code,
note_att.value:name::string as note_att_name,
note_att.value:value::string as note_att_value,
payment_details:avs_result_code::string as payment_data_avs_result_code,
payment_details:credit_card_bin::string as payment_data_credit_card_bin,
payment_details:credit_card_company::string as payment_data_credit_card_company,
payment_details:credit_card_number::string as payment_data_credit_card_number,
payment_details:cvv_result_code::string as payment_data_cvv_result_code,
pay_gate_names.value::string as pay_gate_names,
shipping_address:address1::string as shipping_address1,
shipping_address:address2::string as shipping_address2,
shipping_address:city::string as shipping_city,
shipping_address:company::string as shipping_company,
shipping_address:country::string as shipping_country,
shipping_address:country_code::string as shipping_country_code,
shipping_address:first_name::string as shipping_first_name,
shipping_address:last_name::string as shipping_last_name,
shipping_address:latitude::string as shipping_latitude,
shipping_address:longitude::string as shipping_longitude,
shipping_address:name::string as shipping_name,
shipping_address:phone::string as shipping_phone,
shipping_address:province::string as shipping_province,
shipping_address:province_code::string as shipping_province_code,
shipping_address:zip::string as shipping_zip

from "RIOT_SHOPIFY"."SHOPIFY_RIOTSTORES"."ORDERS" o
,lateral flatten(input => fulfillments) fa // flattens the Fulfillment column
,lateral flatten(input=>fa.value:line_items) fa_line_items // flattens the Line Items Array within the Fulfillment Column
,lateral flatten(input=>fa_line_items.value:tax_lines) fa_line_items_tax_lines //flattens the tax lines array within the Line Items Array within the Fulfillment Column
,lateral flatten(input => line_items) li // flattens the Line_Items column
,lateral flatten(input=>li.value:tax_lines) line_items_tax_lines //flattens the tax lines array within the Line Items Column
,lateral flatten(input=>note_attributes) note_att
,lateral flatten(input => payment_gateway_names) pay_gate_names
where ADMIN_GRAPHQL_API_ID = 'gid://shopify/Order/2131153846349'
limit 100
  //)
;
select * from 
 "RIOT_SHOPIFY"."SHOPIFY_RIOTSTORES"."ORDERS" o
--,lateral flatten(input => billing_address) ba
where ADMIN_GRAPHQL_API_ID = 'gid://shopify/Order/2131153846349'


